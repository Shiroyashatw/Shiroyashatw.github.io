<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>若水資訊</title>
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css'>
  <link rel="stylesheet" href="./css/index.css">
  <link rel="stylesheet" href="./css/style.css">
  <script src="./js/jquery.js"></script>
  <script src="https://kit.fontawesome.com/30fc6417fb.js" crossorigin="anonymous"></script>

  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'>
  </script>
  <script src="./js/script.js"></script>


</head>

<body>

  <script src="./js/index.js">

  </script>
  <!--main content wrapper-->
  <div class="mcw">
    <div class="often">
      <h2>補正表單</h2>
    </div>

    <div class="often">
      <h2>補正期限計算</h2>
      <div onchange="leavetotal()">
        <table id="worktime">
          <tbody id="leavetbody">
            <tr>
              <td>公文時間</td>
              <td>電話通知時間</td>
              <td colspan="2">最後補正期限</td>
            </tr>
            <tr>
              <td><input type="date" name="endhour[]" min="0" id="endhour" maxlength="4"></td>
              <td><input type="date" name="endmin[]" min="0" id="endmin" maxlength="4"></td>
              <td><input type="text" name="leavetime[]" min='0' class="leavetime" value="" placeholder="最後補正期限"
                  readonly></td>
              <td><button onclick="showdate()">計算</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="often">
      <h2>兩次未接回電補正期限</h2>
      <div onchange="secondrecall()">
        <table id="worktime">
          <tbody id="leavetbody">
            <tr>
              <td>第二通沒接時間</td>
              <td>回電時間</td>
              <td>最後補正期限</td>
            </tr>
            <tr>
              <td><input type="date" name="second[]" min="0" class="second"></td>
              <td><input type="date" name="recall[]" min="0" class="recall"></td>
              <td><input type="text" name="lasttime[]" min='0' class="lasttime" value="" placeholder="最後補正期限" readonly>
              </td>
              <td><button onclick="showlasttime()">計算</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
  <script>
      // 計算日期
      function showdate() {
            function difference(date1, date2) {
                const date1utc = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
                const date2utc = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
                day = 1000 * 60 * 60 * 24;
                return (date2utc - date1utc) / day
            }

            const date1 = new Date($("#endhour").val()),
                date2 = new Date($("#endmin").val()),
                time_difference = difference(date1, date2)

            if (time_difference > -5) {
                var newdate = new Date($("#endmin").val()),
                    newdate = newdate.setDate(newdate.getDate() + 5);
                newdate = new Date(newdate).toISOString().slice(0, 10);
                $(".leavetime").attr("value", newdate)
            } else {
                var startdate = new Date($("#endhour").val()).toISOString().slice(0, 10);
                $(".leavetime").attr("value", startdate)

            }
        }


        function showlasttime() {
            function difference(lasttime1, lasttime2) {
                const lasttime1utc = Date.UTC(lasttime1.getFullYear(), lasttime1.getMonth(), lasttime1.getDate());
                const lasttime2utc = Date.UTC(lasttime2.getFullYear(), lasttime2.getMonth(), lasttime2.getDate());
                day = 1000 * 60 * 60 * 24;
                return (lasttime2utc - lasttime1utc) / day
            }

            const lasttime1 = new Date($(".second").val()),
                lasttime2 = new Date($(".recall").val()),
                date_difference = difference(lasttime1, lasttime2)

            switch (true) {
                case date_difference < 0:
                    $(".lasttime").attr("value", "日期錯誤");
                    $(".lasttime").css("color", "red");
                    break;
                case date_difference <= 5:
                    var lastdate = new Date($(".second").val()),
                        lastdate = lastdate.setDate(lastdate.getDate() + 5);
                    lastdate = new Date(lastdate).toISOString().slice(0, 10);
                    $(".lasttime").attr("value", lastdate)
                    $(".lasttime").css("color", "black");
                    break;
                case date_difference > 5:
                    $(".lasttime").attr("value", "超過補正期限");
                    $(".lasttime").css("color", "red");
                    break;
            }
        }
  </script>

</body>

</html>